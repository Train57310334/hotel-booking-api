generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

//
// ─── ENUMS ───────────────────────────────────────────────────────────────
//

enum Role {
  USER
  HOTEL_ADMIN
  PLATFORM_ADMIN
}

//
// ─── USER MANAGEMENT ─────────────────────────────────────────────────────
//

model User {
  id           String   @id @default(cuid())
  email        String   @unique
  passwordHash String
  name         String?
  phone        String?
  roles        String[] @default([]) // user, hotel_admin, platform_admin
  avatarUrl    String?
  
  // CRM Fields
  tags         String[] @default([]) // VIP, Blacklist, Corporate
  notes        String?  // Staff notes
  preferences  String?  // JSON string for dietary, room preferences

  bookings        Booking[]
  reviews         Review[]
  roleAssignments RoleAssignment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  Hotel     Hotel[]
  roomUpdates RoomStatusLog[]
}

//
// ─── ROLE BASED ACCESS CONTROL ───────────────────────────────────────────
//

model RoleAssignment {
  id      String  @id @default(cuid())
  userId  String
  hotelId String?
  role    String // 'user' | 'hotel_admin' | 'platform_admin'

  user  User   @relation(fields: [userId], references: [id])
  hotel Hotel? @relation(fields: [hotelId], references: [id])

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([hotelId])
}

//
// ─── HOTEL AND ROOM STRUCTURE ────────────────────────────────────────────
//

model Hotel {
  id          String   @id @default(cuid())
  package     String   @default("LITE") // LITE, PRO, ENTERPRISE
  name        String
  description String?
  address     String?
  city        String?
  country     String?
  latitude    Float?
  longitude   Float?
  imageUrl    String? // URL to hotel image
  logoUrl     String? // Brand Logo
  images      String[] @default([]) // Gallery/Slider images
  amenities   String[] @default([])

  // Content Management
  contactEmail    String?
  contactPhone    String?
  heroTitle       String?
  heroDescription String?

  // Payment Configuration
  promptPayId       String?
  bankName          String?
  bankAccountName   String?
  bankAccountNumber String?

  // RBAC: owner of this hotel
  ownerId String?
  owner   User?   @relation(fields: [ownerId], references: [id])

  roomTypes  RoomType[]
  reviews    Review[]
  ratePlans  RatePlan[]
  bookings   Booking[]
  promotions Promotion[]
  expenses   Expense[]
  messages   Message[]

  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  RoleAssignment RoleAssignment[]
}



model RoomType {
  id        String              @id @default(cuid())
  hotelId   String
  name      String
  bedConfig String?
  sizeSqm   Int?
  amenities String[]            @default([])
  images    String[]            @default([])
  hotel     Hotel               @relation(fields: [hotelId], references: [id])
  inventory InventoryCalendar[]
  ratePlans RatePlan[]
  bookings  Booking[]
  overrides RateOverride[]
  rooms     Room[]              @relation("RoomTypeRooms")
  description String?
  basePrice Int?
  maxAdults   Int               @default(2)
  maxChildren Int               @default(0)
  isFeatured  Boolean           @default(false)
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @default(now()) @updatedAt
  deletedAt   DateTime?
}

enum RoomStatus {
  CLEAN
  DIRTY
  CLEANING
  INSPECTED
  OOO
}

model Room {
  id         String   @id @default(cuid())
  roomTypeId String
  roomType   RoomType @relation("RoomTypeRooms", fields: [roomTypeId], references: [id])
  bookings    Booking[]  @relation("RoomBookings")
  roomNumber  String? 
  status      RoomStatus @default(CLEAN)
  statusLogs  RoomStatusLog[]
  deletedAt   DateTime?
}

model RoomStatusLog {
  id        String   @id @default(cuid())
  roomId    String
  room      Room     @relation(fields: [roomId], references: [id])
  status    RoomStatus
  
  updatedBy String? 
  user      User?   @relation(fields: [updatedBy], references: [id])

  note      String?

  createdAt DateTime @default(now())

  @@index([roomId])
}

model DailyStat {
  id            String   @id @default(cuid())
  date          DateTime @unique // The date this stat represents (midnight)
  
  totalRevenue  Float    @default(0) // Revenue recognized for this day
  totalBookings Int      @default(0) // Active bookings touching this day
  occupiedRooms Int      @default(0) // Physical count
  occupancyRate Float    @default(0) // Percentage (0-100)
  
  adr           Float    @default(0) // Average Daily Rate = Revenue / Occupied
  revPar        Float    @default(0) // Revenue Per Available Room = Revenue / Total Rooms
  
  createdAt     DateTime @default(now())
}

model InventoryCalendar {
  id         String   @id @default(cuid())
  roomTypeId String
  date       DateTime
  allotment  Int      @default(0)
  stopSale   Boolean  @default(false)
  minStay    Int      @default(1)
  roomType   RoomType @relation(fields: [roomTypeId], references: [id])

  @@unique([roomTypeId, date])
}

model RatePlan {
  id                String  @id @default(cuid())
  hotelId           String
  roomTypeId        String?
  name              String
  includesBreakfast Boolean @default(false)
  cancellationRule  String?
  adultPricePolicy  String?
  childPricePolicy  String?

  hotel     Hotel          @relation(fields: [hotelId], references: [id])
  roomType  RoomType?      @relation(fields: [roomTypeId], references: [id])
  overrides RateOverride[]
  bookings  Booking[]
}

model RateOverride {
  id         String   @id @default(cuid())
  roomTypeId String
  ratePlanId String
  date       DateTime
  baseRate   Int
  reason     String?
  roomType   RoomType @relation(fields: [roomTypeId], references: [id])
  ratePlan   RatePlan @relation(fields: [ratePlanId], references: [id])

  @@unique([roomTypeId, ratePlanId, date])
}

//
// ─── PROMOTIONS AND DISCOUNTS ───────────────────────────────────────────
//

model Promotion {
  id         String   @id @default(cuid())
  code       String   @unique
  type       String // percent | fixed
  value      Int
  startDate  DateTime
  endDate    DateTime
  conditions String?

  // Optional: apply only to a specific hotel
  hotelId String?
  hotel   Hotel?  @relation(fields: [hotelId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

//
// ─── BOOKINGS AND PAYMENTS ──────────────────────────────────────────────
//

model Booking {
  id              String   @id @default(cuid())
  userId          String?
  hotelId         String
  roomTypeId      String
  ratePlanId      String
  checkIn         DateTime
  checkOut        DateTime
  guestsAdult     Int
  guestsChild     Int
  totalAmount     Int
  status          String // pending/confirmed/cancelled/checked_in/checked_out/no_show
  leadName        String
  leadEmail       String
  leadPhone       String
  specialRequests String?

  user     User?    @relation(fields: [userId], references: [id])
  hotel    Hotel    @relation(fields: [hotelId], references: [id])
  roomType RoomType @relation(fields: [roomTypeId], references: [id])
  ratePlan RatePlan @relation(fields: [ratePlanId], references: [id])
  payment  Payment?

  room    Room    @relation("RoomBookings", fields: [roomId], references: [id])
  roomId  String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  guests    Guest[]
  folioCharges FolioCharge[]
}

model Guest {
  id          String   @id @default(cuid())
  bookingId   String
  name        String
  idType      String   @default("passport") // passport, national_id, driving_license
  idNumber    String?
  documentUrl String?  // Path to uploaded ID image
  
  booking     Booking  @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Payment {
  id        String  @id @default(cuid())
  bookingId String  @unique
  provider  String
  intentId  String?
  chargeId  String?
  amount    Int
  currency  String  @default("THB")
  status    String // created/authorized/captured/voided/refunded/failed
  method    String? // card, promptpay, cash
  
  booking   Booking @relation(fields: [bookingId], references: [id])
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt @default(now())
}

model FolioCharge {
  id          String   @id @default(cuid())
  bookingId   String
  description String
  amount      Int      // In THB
  type        String   @default("OTHER") // ROOM_SERVICE, LAUNDRY, MINIBAR, DAMAGE, OTHER
  date        DateTime @default(now())
  
  createdBy   String?
  // user     User?    @relation(fields: [createdBy], references: [id]) // Optional: track who added charge

  booking     Booking  @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

//
// ─── REVIEWS ────────────────────────────────────────────────────────────
//

model Review {
  id        String   @id @default(cuid())
  hotelId   String
  userId    String
  rating    Int
  comment   String?
  status    String   @default("pending") // pending/approved/rejected
  hotel     Hotel    @relation(fields: [hotelId], references: [id])
  user      User     @relation(fields: [userId], references: [id])
  createdAt DateTime @default(now())
}

//
// ─── MESSAGES ───────────────────────────────────────────────────────────
//

model Message {
  id        String   @id @default(cuid())
  name      String
  email     String
  subject   String?
  content   String
  status    String   @default("unread") // unread, read, replied
  createdAt DateTime @default(now())

  hotelId   String?
  hotel     Hotel?   @relation(fields: [hotelId], references: [id])
}

//
// ─── SYSTEM SETTINGS ────────────────────────────────────────────────────
//

model SystemSetting {
  key       String   @id
  value     String   // DB connection string, API keys, JSON config
  category  String   @default("general") // general, payment, notification
  updatedAt DateTime @updatedAt
}

model Notification {
  id        String   @id @default(cuid())
  title     String
  message   String
  type      String   @default("info") // info, success, warning, error
  userId    String?  // Optional: specific to a user
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())
}

model Expense {
  id        String   @id @default(cuid())
  hotelId   String
  title     String
  amount    Int // In Subunits (e.g. Satang) or Integer THB depending on convention. Assuming Integer THB based on Booking.totalAmount
  date      DateTime
  category  String   @default("general") // utilities, salary, maintenance, marketing
  
  hotel     Hotel    @relation(fields: [hotelId], references: [id])
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
